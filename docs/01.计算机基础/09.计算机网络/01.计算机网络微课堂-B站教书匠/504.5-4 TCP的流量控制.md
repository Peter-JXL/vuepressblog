---
title: 5.4 TCP的流量控制
date: 2023-11-16 15:51:57
permalink: /Network/Transport-layer/5.4
categories:
  - 计算机基础
  - 计算机网络
  - 计算机网络微课堂-B站教书匠
tags:
  - 
---


## 5.4 TCP的流量控制

　　本节课我们介绍TCP的流量控制，
<!-- more -->

* 一般来说我们总是希望数据传输的更快一些
* 但如果发送方把数据发送的过快，接收方就可能来不及接收，这就会造成数据的丢失
* 所谓流量控制就是让发送方的发送速率不要太快，要让接收方来得及接收
* 利用滑动窗口机制，可以很方便的在TCP连接上实现对发送方的流量控制

　　‍

　　我们来举例说明，假设主机A和B是因特网上的两台主机，它们之间已经建立了TCP连接，A给B发送数据，B对A进行流量控制，这是主机A中带发送数据的字节序号，假设主机A发送的每个TCP报文段可携带100字节数据，因此图中每个小格子表示100个字节数据的序号，在主机A和B建立TCP连接时，B告诉A我的接收窗口为400，因此主机A将自己的发送窗口也设置为400，这意味着主机A在未收到主机B发来的确认时，可将序号落入发送窗口中的全部数据发送出去。

　　‍

　　接下来我们举例说明主机B对A的流量控制，主机A将发送窗口内序号1\~100的数据，封中成一个TCP报文段发送出去，发送窗口内还有300字节可以发送。这里的seq是TCP报文段首部中的序号字段，取值一，表示TCP报文段数据载荷的第一个字节的序号是一，这里的DATA表示这是TCP数据报文段，主机A将发送窗口内序号101\~200的数据，封中成一个TCP报文段发送出去，发送窗口内还有200字节可以发送，主机A将发送窗口内，序号201\~300的数据，封中成一个TCP报文段发送出去，但该报文段在传输过程中丢失了，主机A发送窗口内还有100字节可以发送。主机B对主机A所发送的201号以前的数据进行累计确认，并在该累计确认中将窗口字段的值调整为300，也就是对主机A进行流量控制。这里的大写ACK是TCP报文段首部中的标志位，取值一，表示这是一个TCP确认报文段，小写ack是TCP报文段首部中的确认号字段，取值201，表示序号201之前的数据已全部正确接收，现在希望收到序号201及其后续数据。

　　RWND是TCP报文段首部中的窗口字段，取值300，表示自己的接收窗口大小为300。主机A收到该累计确认后，将发送窗口向前滑动，使已发送并收到确认的这些数据的序号，移出发送窗口。

　　![](https://image.peterjxl.com/blog/image-20211219102013-pdxi38m.png)

　　‍

　　‍

　　由于主机B在该累计确认中，将自己的接收窗口调整为了300，因此主机A相应的将自己的发送窗口调整为300。目前主机A发送窗口内的序号为201\~500，也就是主机A还可以发送这300字节，其中201\~300号字节是已发送的数据，若重传计时器超时，他们会被重传。301号到400号字节，以及401号到500号字节还未被发送，可被分别封中在一个TCP报文段中发送。主机A现在可将发送缓存中序号1\~200的字节数据全部删除了，因为已经收到了主机B对他们的累计确认。

　　主机A将发送窗口内序号301\~400个数据，封中成一个TCP报文段发送出去，发送窗口内还有100字节可以发送，主机A将发送窗口内序号401\~500的数据，封中成一个TCP报文段发送出去，至此序号落在发送窗口内的数据已经全部发送出去了，不能再发送新数据了。  
现在发送窗口内序号201\~300，这100个字节数据的重传计时器超时了，主机A将它们重新封中成一个TCP报文段发送出去，暂时不能发送其他数据。

　　主机B收到该重传的TCP报文段后，对主机A所发送的501号以前的数据进行累计确认，并在该累计确认中将窗口字段的值调整为100。这是主机B对主机A进行的第二次流量控制。

　　![](https://image.peterjxl.com/blog/image-20211219102251-zf0pooy.png)

　　‍

　　主机A收到该累计确认后，将发送窗口向前滑动，使已发送并收到确认的这些数据的序号，移出发送窗口。由于主机B在该累计确认中将自己的接收窗口调整为了100，因此主机A相应的将自己的发送窗口调整为100。目前主机A发动窗口内的序号为501\~600，也就是主机A还可以发送这100字节，主机A现在可将发送缓存中序号201\~500的字节数据全部删除了，因为已经收到了主机B对他们的累积确认，主机A将发送窗口内序号501\~600的数据，封中成一个TCP报文段发送出去，至此序号落在发送窗口内的数据已经全部发送出去了，不能再发送新数据了。主机B对主机A所发送的601号以前的数据进行累计确认，并在该领域确认中将窗口字段的值调整为0。这是主机B对主机A进行的第三次流量控制。

　　![](https://image.peterjxl.com/blog/image-20211219102343-pcgji7r.png)

　　‍

　　主机A收到该累计确认后，将发送窗口向前滑动，使已发送并收到确认的这些数据的序号，移出发送窗口。由于主机B在该累计确认中将自己的接收窗口调整为了0，因此主机A相应的将自己的发送窗口调整为0。目前主机A不能再发送一般的TCP报文段了，主机A现在可将发送缓存中序号501\~600的字节数据全部删除了，因为已经收到了主机币被他们的累计确认，假设主机B向主机A发送了0窗口的报文段后不久，主机B的接收缓存又有了一些存储空间，于是主机B向主机A发送了接收窗口等于300的报文段，然而这个报文段在传输过程中丢失了，主机A一直等待主机B发送的非0窗口的通知，而主机B也一直等待主机A发送的数据，如果不采取措施，这种互相等待而形成的死锁局面将一直持续下去。为了解决这个问题，TCP为每一个连接设有一个持续计时器，只要TCP连接的一方，收到对方的0窗口通知，就要起到持续计时器。若持续计时器超时，就要发送一个0窗口探测报文，仅携带一字节的数据，而对方在确认这个探测报文段时，给出自己现在的接收窗口值。如果接收窗口仍然是0，那么收到报文段的一方要重新启动持续计时器，如果接收窗口不是0，那么死锁的局面就可以被打破了。

　　![](https://image.peterjxl.com/blog/image-20211219102533-qh4u1ne.png)

　　‍

　　在本例中，主机A收到零窗口通知时，就要启动一个持续计时器，当持续计时器超时，主机A立刻发送一个仅携带一字节数据的零窗口探测保温段，假设主机B此时的接收窗口又为0了，主机B就在确认零窗口探测报文段时，给出自己现在的接收窗口值为零。主机A再次收到零窗口通知，就要再次启动一个持续计时器，当持续计时器超时，主机A立刻发送一个零窗口探测报文段，假设主机B此时的接收缓存又有了一些存储空间，于是将自己的接收窗口调整为了300，主机B就在确认零窗口探测报文段时，给出自己现在的接收窗口值为300，这样就打破了死锁的局面。

　　![](https://image.peterjxl.com/blog/image-20211219102644-kllta01.png)

　　同学们可能会有这样的疑问，主机A所发送的零窗口探测报文段到达主机B时，如果主机B此时的接收窗口仍然为0，那么主机B根本就无法接受该报文段，又怎么会针对该报文段给主机A发回确认呢？实际上TCP规定即使接收窗口为0，也必须接受零窗口探测报文段，确认报文段，以及携带有紧急数据的报文段。

　　请大家再来思考一下这个问题。如果零窗口探测报文段丢失了，会出现怎样的问题呢？还能否打破死锁的局面呢？回答是肯定的，因为零窗口探测报文段也有重传计时器，当重传计时器超时后，零窗口探测报文段会被重传。

　　‍

　　‍

　　‍

　　‍

　　接下来我们来做一个相关的练习题，这是计算机专业考研全国统考计算机网络部分2010年的题39，由于该题涉及到了我们还未学习的拥塞控制的内容，因此我们需要先做一些说明，然后再请同学们来完成。TCP发送方的发送窗口，实际上是在自身的拥塞窗口和TCP接收方的接收窗口中取小者。而在我们本节课的举例中，为了简单起见，我们忽略了拥塞控制，也就是认为TCP发送方的发送窗口等于接收方的接收窗口。本题未给出TCP发送方的发送窗口的初始值，则我们取拥塞窗口值作为发送窗口值。

　　答案是选项A  我们来一起画图分析一下，这是主机假中带发送数据的序号。根据题意可知，主机甲的发动窗口为4000字节，主机甲向主机乙连续发送两个最大段，共2000字节，也就是将发送窗口内，序号0\~1999的字节数据发送出去，主机乙给主机甲发送针对第一个段的确认，并在该确认中给出自己当前的接收窗口大小为2000字节，主机甲收到该确认后，将发送窗口向前滑动，使已发送并收到确认的第一个段的序号移出发送窗口。由于主机乙在确认中给出的自己的接收窗口大小为2000字节，因此主机甲相应的将自己的发送窗口调整为2000字节，很显然主机甲还可以向主机乙发送2000\~2999号字节数据，共1000个字节，

　　![](https://image.peterjxl.com/blog/image-20211219102914-kggamna.png)

　　‍

　　本节课的内容小结如下

　　![](https://image.peterjxl.com/blog/image-20211219102944-hkw9zic.png)
